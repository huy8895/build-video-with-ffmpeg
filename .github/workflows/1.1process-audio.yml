name: ğŸ§ Process Audio

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string
      folder_url:
        required: true
        type: string
      video_number:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      env:
        description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)'
        required: true
        default: 'ose'
        type: choice
        options:
          - ose
          - mep
          - dde
      folder_url:
        description: 'Link folder Google Drive chá»©a audio.zip vÃ  content.txt'
        required: true
      video_number:
        description: 'Sá»‘ Thá»© tá»± video (1, 2, 3, ...)'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    name: "Audio  Channel: ${{ inputs.env }} | Video: #${{ inputs.video_number }}"

    env:
      CHANNEL: ${{ inputs.env }}
      FOLDER_URL: ${{ inputs.folder_url }}
      VIDEO_NUMBER: ${{ inputs.video_number }}
      CONFIG_JSON: ${{ vars.CONFIG_JSON }}
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      GG_REFRESH_TOKEN: ${{ secrets.GG_REFRESH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        
      - name: Install dependencies send mail
        run: npm install nodemailer

      - name: ğŸ§ª Parse CONFIG_JSON into environment variables
        id: parse
        run: |
          echo "$CONFIG_JSON" > config.json
          echo "WHISPER_MODEL=$(jq -r '.whisper_model' config.json)" >> $GITHUB_ENV
          echo "SPEED=$(jq -r '.speed' config.json)" >> $GITHUB_ENV
          echo "MAX_WORDS_PER_LINE=$(jq -r '.max_words_per_line' config.json)" >> $GITHUB_ENV
          echo "LANGUAGE=$(jq -r '.language' config.json)" >> $GITHUB_ENV
          echo "VOLUME=$(jq -r '.volume' config.json)" >> $GITHUB_ENV
          echo "EMAIL=$(jq -r '.email' config.json)" >> $GITHUB_ENV
      - name: ğŸ Táº¡o link Ä‘áº¿n workflow run
        run: |
          echo "RUN_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
      - name: "ğŸ“© Notify: Start processing AUDIO"
        run: |
          export MESSAGE="âœ…Done  ğŸ“º Channel: [$CHANNEL] | Video: #$VIDEO_NUMBER ğŸ§  WhisperModel: $WHISPER_MODEL | ğŸšï¸ Speed: $SPEED | ğŸ—£ï¸ Lang: $LANGUAGE ğŸ“ Folder: $FOLDER_URL ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}
          
          
      - name: ğŸ Install Python & Google API packages
        run: pip install google-auth google-api-python-client

      - name: â¬‡ï¸ Download audio.zip & content.txt from Google Drive folder
        run: |
          python scripts/download_drive_folder_files.py audio.zip content.txt

      - name: ğŸ“ Kiá»ƒm tra file táº£i vá»
        run: ls -lh input/

      - name: ğŸ“‚ Giáº£i nÃ©n file audio.zip
        run: |
          rm -rf audio merged
          mkdir -p audio merged
          unzip -o input/audio.zip -d audio
          find audio -maxdepth 1 -type f -name "*.mp3" | sort -V > merged/sorted.txt
          cat merged/sorted.txt

      - name: ğŸ› ï¸ CÃ i Ä‘áº·t ffmpeg vÃ  whisper
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install --upgrade pip
          pip install setuptools-rust openai-whisper

      - name: ğŸ”— Chuáº©n hÃ³a Ä‘á»‹nh dáº¡ng vÃ  ná»‘i file audio (.mp3 | .wav)
        run: |
          mkdir -p merged fixed_mp3
          rm -f merged/list.txt
          
          echo "ğŸ“‹ QuÃ©t file audioâ€¦"
          # Xuáº¥t Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i, NUL-delimited
          find "$(pwd)/audio" -maxdepth 1 -type f \( -iname "*.mp3" -o -iname "*.wav" \) \
               -print0 | sort -zV |
          while IFS= read -r -d '' f; do
            n=$((n+1))
            out="fixed_mp3/${n}.mp3"
            echo "ğŸµ [$n] $(basename "$f") â†’ $(basename "$out")"
            ffmpeg -nostats -loglevel error -y \
                   -i "$f" -vn -ar 44100 -ac 2 -b:a 256k "$out"
            printf "file '%s/%s'\n" "$PWD" "$out" >> merged/list.txt
          done
          
          echo "ğŸ§© Merging filesâ€¦"
          ffmpeg -nostats -loglevel error -f concat -safe 0 -i merged/list.txt \
                 -c copy merged/merged.mp3
      
      - name: ğŸ¢ Äiá»u chá»‰nh tá»‘c Ä‘á»™ & Ã¢m lÆ°á»£ng audio
        run: |
          mkdir -p adjusted
          ffmpeg -i merged/merged.mp3 -filter:a "atempo=$SPEED,volume=$VOLUME" -vn adjusted/audio_adjusted.mp3
      - name: âœï¸ Táº¡o phá»¥ Ä‘á» SRT
        run: |
          whisper adjusted/audio_adjusted.mp3 \
            --language "$LANGUAGE" \
            --model "$WHISPER_MODEL" \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line "$MAX_WORDS_PER_LINE" \
            --output_dir output

      - name: ğŸ·ï¸ Äá»•i tÃªn & di chuyá»ƒn file
        run: |
          mv output/audio_adjusted.srt transcript.srt
          cp adjusted/audio_adjusted.mp3 audio_adjusted.mp3

      - name: â˜ï¸ Upload lÃªn Google Drive
        run: |
          export UPLOAD_FILES="audio_adjusted.mp3 transcript.srt"
          python scripts/upload_results_to_drive.py

      - name: ğŸš€ Gá»­i tin nháº¯n Telegram
        run: |
          export MESSAGE="âœ…Done ${{ github.workflow }} ! Channel [$CHANNEL] Video: #$VIDEO_NUMBER | WhisperModel: $WHISPER_MODEL | Speed: $SPEED | Lang: $LANGUAGE | âœ… Done! ğŸ“ $FOLDER_URL ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}
          
          
      - name: ğŸ“› Notify Telegram if job failed
        if: failure()
        run: |
          export MESSAGE="âŒ ${{ github.workflow }} tháº¥t báº¡i! Channel [$CHANNEL] Video: #$VIDEO_NUMBER | ğŸ“ $FOLDER_URL ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}
          
