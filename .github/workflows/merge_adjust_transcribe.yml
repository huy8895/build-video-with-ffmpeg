name: Merge, Adjust Speed, and Transcribe MP3

on:
  workflow_dispatch:
    inputs:
      folder_url:
        description: 'Link folder Google Drive chá»©a audio.zip vÃ  content.txt'
        required: true
      whisper_model:
        description: 'Model Whisper (tiny, small, medium, large)'
        required: true
        default: 'tiny'
      video_number:
        description: 'Sá»‘ Thá»© tá»± video (1, 2, 3, ...)'
        required: true
        default: '0'
      speed:
        description: 'Tá»‘c Ä‘á»™ Ä‘iá»u chá»‰nh audio (vÃ­ dá»¥: 0.8, 1.0, 1.2)'
        required: true
        default: '0.8'
      max_words_per_line:
        description: 'Sá»‘ tá»« tá»‘i Ä‘a má»—i dÃ²ng phá»¥ Ä‘á» (vÃ­ dá»¥: 1, 5, 8)'
        required: true
        default: '1'
      language:
        description: 'NgÃ´n ngá»¯ cá»§a file audio (en, vi, es, etc.)'
        required: true
        default: 'en'

jobs:
  merge-adjust-transcribe:
    name: "Video: #${{ github.event.inputs.video_number }} | ðŸŽ§ Whisper: ${{ github.event.inputs.whisper_model }} | ðŸ¢ Speed: ${{ github.event.inputs.speed }} | ðŸŒ Language: ${{ github.event.inputs.language }}"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout source code
        uses: actions/checkout@v4

      - name: ðŸ Install Python & Google API packages
        run: pip install google-auth google-api-python-client

      - name: â¬‡ï¸ Download audio.zip & content.txt from Google Drive folder
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          FOLDER_URL: ${{ github.event.inputs.folder_url }}
        run: |
          mkdir -p input
          python scripts/download_drive_folder_files.py

      - name: ðŸ“‚ Giáº£i nÃ©n file audio.zip
        run: |
          rm -rf audio merged
          mkdir -p audio merged
          unzip -o input/audio.zip -d audio
          echo "âœ… Danh sÃ¡ch file .mp3 sau giáº£i nÃ©n:"
          find audio -maxdepth 1 -type f -name "*.mp3" | sort -V > merged/sorted.txt
          cat merged/sorted.txt

      - name: ðŸ› ï¸ CÃ i Ä‘áº·t ffmpeg vÃ  whisper
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install --upgrade pip
          pip install setuptools-rust
          pip install openai-whisper

      - name: ðŸ”— Ná»‘i táº¥t cáº£ file .mp3 theo thá»© tá»± tÃªn tÄƒng dáº§n
        run: |
          mkdir -p merged
          ls audio/*.mp3 | sort -V > merged/sorted.txt
          while read f; do
            echo "file '$PWD/$f'" >> merged/list.txt
          done < merged/sorted.txt
          echo "ðŸ“ƒ Danh sÃ¡ch merge:"
          cat merged/list.txt
          ffmpeg -f concat -safe 0 -i merged/list.txt -c copy merged/merged.mp3

      - name: "ðŸ¢ Äiá»u chá»‰nh tá»‘c Ä‘á»™ audio (speed: ${{ github.event.inputs.speed }})"
        run: |
          mkdir -p adjusted
          ffmpeg -i merged/merged.mp3 -filter:a "atempo=${{ github.event.inputs.speed }}" -vn adjusted/audio_adjusted.mp3

      - name: "âœï¸ Chuyá»ƒn thÃ nh phá»¥ Ä‘á» SRT báº±ng Whisper ${{ github.event.inputs.whisper_model }} | ${{ github.event.inputs.language }} | ${{ github.event.inputs.max_words_per_line }} words/line | ${{ github.event.inputs.speed }}x"
        run: |
          echo "ðŸ§  Whisper model: ${{ github.event.inputs.whisper_model }}"
          echo "ðŸ¢ Audio speed: ${{ github.event.inputs.speed }}"
          echo "ðŸ—£ï¸ Language: ${{ github.event.inputs.language }}"
          echo "ðŸ§¾ Max words/line: ${{ github.event.inputs.max_words_per_line }}"
          whisper adjusted/audio_adjusted.mp3 \
            --language ${{ github.event.inputs.language }} \
            --model ${{ github.event.inputs.whisper_model }} \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line ${{ github.event.inputs.max_words_per_line }} \
            --output_dir output

      - name: ðŸ·ï¸ Äá»•i tÃªn file Ä‘áº§u ra && Di chuyá»ƒn file Ä‘áº§u ra vá» thÆ° má»¥c gá»‘c
        run: |
          mv output/audio_adjusted.srt transcript.srt
          cp adjusted/audio_adjusted.mp3 audio_adjusted.mp3
      - name: â¬†ï¸ Upload káº¿t quáº£ vá» Google Drive
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          FOLDER_URL: ${{ github.event.inputs.folder_url }}
        run: |
          python scripts/upload_results_to_drive.py audio_adjusted.mp3 transcript.srt
      - name: ðŸ“£ Notify Telegram
        run: |
          MESSAGE="ðŸŽ‰ Video #${{ github.event.inputs.video_number }} done: Adjusted speed & transcript completed!\nðŸ”— Drive: ${{ github.event.inputs.drive_url }}" \
          node scripts/send_telegram_message.js
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
