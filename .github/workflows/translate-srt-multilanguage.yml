name: ğŸŒ Translate SRT from Google Drive

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)'
        required: true
        default: 'ose'
        type: choice
        options:
          - ose
          - mep
          - cdp
      folder_url:
        description: "Google Drive folder URL chá»©a file SRT gá»‘c"
        required: true
      source_srt_filename:
        description: "TÃªn file SRT gá»‘c trong folder (vÃ­ dá»¥: raw_cn.srt)"
        required: true
        default: "raw_cn.srt"
      languages:
        description: "Danh sÃ¡ch ngÃ´n ngá»¯ Ä‘Ã­ch, cÃ¡ch nhau báº±ng dáº¥u pháº©y (vÃ­ dá»¥: English, Vietnamese, Japanese)"
        required: true
        default: "English, Vietnamese, Japanese"
      model:
        description: 'Gemini model (vÃ­ dá»¥ gemini-2.5-pro)'
        required: false
        default: 'gemini-2.5-pro'
      thinking_budget:
        description: 'Thinking budget (-1 dynamic, 0 off, or positive int)'
        required: false
        default: '-1'

jobs:
  translate-and-upload:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    env:
      FOLDER_URL:       ${{ inputs.folder_url }}
      GG_REFRESH_TOKEN: ${{ secrets.GG_REFRESH_TOKEN }}
      YT_CLIENT_ID:     ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      GEMINI_API_KEY:   ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai google-auth google-api-python-client

      - name: ğŸ“‚ Download source SRT from Drive
        id: download_srt
        run: |
          set -euo pipefail
          SOURCE_FILE="${{ inputs.source_srt_filename }}"
          python scripts/download_drive_folder_files.py "$SOURCE_FILE"
          
          if [ ! -f "input/$SOURCE_FILE" ]; then
            echo "::error::Failed to download $SOURCE_FILE from Google Drive."
            exit 1
          fi
          
          echo "SRT_PATH=input/$SOURCE_FILE" >> $GITHUB_ENV
          echo "SRT_BASE_NAME=$(basename "$SOURCE_FILE" .srt)" >> $GITHUB_ENV
          echo "Downloaded file:"
          ls -lh "input/$SOURCE_FILE"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Láº·p qua cÃ¡c ngÃ´n ngá»¯ vÃ  dá»‹ch (ÄÃƒ Cáº¬P NHáº¬T LOGIC Lá»–I)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”„ Translate for each language (with error skipping)
        id: run_translations
        run: |
          # KHÃ”NG dÃ¹ng 'set -e' á»Ÿ Ä‘Ã¢y Ä‘á»ƒ cÃ³ thá»ƒ xá»­ lÃ½ lá»—i trong vÃ²ng láº·p
          set -uo pipefail

          SUCCESSFUL_FILES=""
          FAILED_LANGS=() # Máº£ng Ä‘á»ƒ lÆ°u cÃ¡c ngÃ´n ngá»¯ bá»‹ lá»—i

          # Chuyá»ƒn Ä‘á»•i chuá»—i "lang1, lang2" thÃ nh má»™t máº£ng Ä‘á»ƒ láº·p
          IFS=',' read -r -a LANG_ARRAY <<< "${{ inputs.languages }}"

          for lang_raw in "${LANG_ARRAY[@]}"; do
            lang=$(echo "$lang_raw" | xargs) # Trim whitespace
            echo "---"
            echo "ğŸš€ Starting translation to: '$lang'"
            
            SAFE_LANG=$(echo "$lang" | tr ' ' '_')
            OUT_PATH="output/${{ env.SRT_BASE_NAME }}.${SAFE_LANG}.srt"
            mkdir -p output

            # Cháº¡y lá»‡nh dá»‹ch vÃ  kiá»ƒm tra mÃ£ thoÃ¡t cá»§a nÃ³
            # Náº¿u lá»‡nh khÃ´ng thÃ nh cÃ´ng (!), nÃ³ sáº½ vÃ o khá»‘i 'if'
            if ! python scripts/translate_srt.py \
              --input "${{ env.SRT_PATH }}" \
              --language "$lang" \
              --output "$OUT_PATH" \
              --model "${{ inputs.model }}" \
              --thinking-budget "${{ inputs.thinking_budget }}"; then
              
              # Ghi láº¡i lá»—i vÃ  tiáº¿p tá»¥c vÃ²ng láº·p
              echo "::warning::Translation to '$lang' failed. Skipping this language."
              FAILED_LANGS+=("$lang")
            else
              # Náº¿u thÃ nh cÃ´ng, thÃªm file vÃ o danh sÃ¡ch Ä‘á»ƒ upload
              echo "âœ… Translation to '$lang' succeeded. Output: $OUT_PATH"
              SUCCESSFUL_FILES="$SUCCESSFUL_FILES $OUT_PATH"
            fi
          done

          # LÆ°u danh sÃ¡ch cÃ¡c file thÃ nh cÃ´ng vÃ o biáº¿n mÃ´i trÆ°á»ng
          echo "ALL_TRANSLATED_FILES=${SUCCESSFUL_FILES# }" >> $GITHUB_ENV

          # KIá»‚M TRA CUá»I CÃ™NG: Náº¿u cÃ³ báº¥t ká»³ lá»—i nÃ o, lÃ m cho job tháº¥t báº¡i
          echo "---"
          echo "ğŸ“Š Translation Summary:"
          if [ ${#FAILED_LANGS[@]} -ne 0 ]; then
            # DÃ¹ng ::error:: Ä‘á»ƒ GitHub Actions nháº­n diá»‡n Ä‘Ã¢y lÃ  lá»—i
            echo "::error::Job finished with errors. The following languages failed: ${FAILED_LANGS[*]}"
            exit 1
          else
            echo "âœ… All languages translated successfully!"
          fi

      - name: â˜ï¸ Upload all results to Drive
        run: |
          if [ -z "${{ env.ALL_TRANSLATED_FILES }}" ]; then
            echo "No files were successfully translated. Skipping upload."
          else
            echo "Uploading successfully translated files: ${{ env.ALL_TRANSLATED_FILES }}"
            export UPLOAD_FILES="${{ env.ALL_TRANSLATED_FILES }}"
            python scripts/upload_results_to_drive.py
          fi

      - name: ğŸ“œ Show a preview of generated files
        run: |
          echo "âœ… Translation process completed."
          echo "Generated files:"
          ls -lhR output/