name: ğŸ“€ Render Video & Upload From Slide

on:
  workflow_call:
    inputs:
      env:           { required: true,  type: string }
      folder_url:    { required: true,  type: string }
      video_number:  { required: true,  type: string }
  workflow_dispatch:
    inputs:
      env:          { description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)', default: 'ose', type: choice, options: [ose, mep, dde] }
      video_number: { description: 'Video number', default: '0',     required: true }
      folder_url:   { description: 'Google Drive folder URL',        required: true }

jobs:
  render-video:
    name: "Video | ${{ inputs.env }} | #${{ inputs.video_number }}"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}

    env:
      CHANNEL:         ${{ inputs.env }}
      FOLDER_URL:      ${{ inputs.folder_url }}
      VIDEO_NUMBER:    ${{ inputs.video_number }}
      CONFIG_JSON:     ${{ vars.CONFIG_JSON }}
      YT_CLIENT_ID:        ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET:    ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN:    ${{ secrets.YT_REFRESH_TOKEN }}
      GG_REFRESH_TOKEN:    ${{ secrets.GG_REFRESH_TOKEN }}
      TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
      YOUTUBE_META_JSON:   ${{ vars.YOUTUBE_META_JSON }}

    steps:
      - uses: actions/checkout@v4
      - name: ğŸ Táº¡o link Ä‘áº¿n workflow run
        run: |
          echo "RUN_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

      - name: "ğŸ“© Notify: Start render"
        run: |
          export MESSAGE="â–¶ï¸ [$CHANNEL] Video #$VIDEO_NUMBER: Báº¯t Ä‘áº§u RENDER & UPLOAD ğŸ¬ | ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Parse CONFIG_JSON (giá»¯ láº¡i toÃ n bá»™ biáº¿n video)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Validate CONFIG_JSON
        run: |
          echo "$CONFIG_JSON" > config.json
          if ! jq -e '(.dpi and .resolution and .config_key and .maxChar and .minChar and .matchThreshold and .maxOffset)' config.json > /dev/null; then
            echo "âŒ CONFIG_JSON thiáº¿u trÆ°á»ng!" && exit 1
          fi

      - name: ğŸ¤– Parse CONFIG_JSON â‡’ env
        run: |
          echo "$CONFIG_JSON" > config.json
          echo "DPI=$(jq -r '.dpi'           config.json)" >> $GITHUB_ENV
          echo "RESOLUTION=$(jq -r '.resolution' config.json)" >> $GITHUB_ENV
          echo "CONFIG_KEY=$(jq -r '.config_key' config.json)" >> $GITHUB_ENV
          echo "MAX_CHAR=$(jq -r '.maxChar'  config.json)" >> $GITHUB_ENV
          echo "MIN_CHAR=$(jq -r '.minChar'  config.json)" >> $GITHUB_ENV
          echo "MATCH_THRESHOLD=$(jq -r '.matchThreshold' config.json)" >> $GITHUB_ENV
          echo "MAX_OFFSET=$(jq -r '.maxOffset' config.json)" >> $GITHUB_ENV
          # Cho phÃ©p táº¯t/báº­t upload tuá»³ file JSON
          echo "UPLOAD_TO_YOUTUBE=$(jq -r '.upload_to_youtube' config.json)" >> $GITHUB_ENV
          echo "UPLOAD_VIDEO_TO_DRIVE=$(jq -r '.upload_video_to_drive' config.json)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. CÃ i deps & táº£i file (Ä‘Ã£ cÃ³ slides.pptx)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: ğŸ“¦ Install Node + Python + system deps
        run: |
          npm install fs-extra minimist compromise googleapis
          pip install --upgrade google-api-python-client google-auth google-auth-oauthlib
          sudo apt-get update
          sudo apt-get install -y libreoffice poppler-utils ffmpeg
      - name: "ğŸŒŸ Install font"
        run: |
          mkdir -p ~/.fonts && cp assets/fonts/*.ttf ~/.fonts/ && fc-cache -f -v

      - name: ğŸ“‚ Download files (slides + audio + timing + background)
        run: |
          python scripts/download_drive_folder_files.py slides.pptx transcript.srt audio_adjusted.mp3 background.jpg timings.json
          ls -lh input/
          cp input/* . || true

      # Náº¿u cáº§n build timing láº¡i (thÆ°á»ng khÃ´ng cáº§n)
      # - name: ğŸ§  Generate timing (tuá»³ chá»n) â€¦

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Convert & render
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“„ Convert PPTX â†’ PDF
        run: |
          mkdir -p slides_pdf
          soffice --headless --convert-to pdf --outdir slides_pdf slides.pptx

      - name: ğŸ–¼ PDF â†’ PNG
        run: |
          mkdir -p slides_png
          pdftoppm -png -r "$DPI" slides_pdf/slides.pdf slides_png/slide

      - name: ğŸ“ Build input.txt
        run: IMAGES_DIR=slides_png node scripts/build_input_list.js

      - name: ğŸ Render video
        run: |
          case "$RESOLUTION" in
            "720p")  SIZE="1280:720" ;;
            "1080p") SIZE="1920:1080" ;;
            *)       SIZE="854:480"  ;;
          esac
          ffmpeg -y -f concat -safe 0 -i input.txt -i audio_adjusted.mp3 \
            -vf "scale=$SIZE,format=yuv420p" \
            -c:v libx264 -preset slow -crf 18 \
            -c:a aac -b:a 320k -shortest output.mp4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Upload Drive / YouTube + Notify
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜ï¸ Upload VIDEO to Drive
        if: ${{ env.UPLOAD_VIDEO_TO_DRIVE == 'true' }}
        run: |
          export UPLOAD_FILES="output.mp4"
          python scripts/upload_results_to_drive.py

      - name: ğŸš€ Upload YouTube
        if: ${{ env.UPLOAD_TO_YOUTUBE == 'true' }}
        run: python scripts/upload_youtube.py

      - name: ğŸ“© Notify success
        if: ${{ env.UPLOAD_TO_YOUTUBE == 'true' }}
        run: |
          YT_LINK=$(cat yt_link.txt)
          export MESSAGE="ğŸ‰ [$CHANNEL] Video #$VIDEO_NUMBER Ä‘Ã£ upload! ğŸ‘‰ $YT_LINK | ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js

      - name: ğŸ“› Notify failure
        if: failure()
        run: |
          export MESSAGE="âŒ Render/Upload FAILED â€“ [$CHANNEL] #$VIDEO_NUMBER | $FOLDER_URL | ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js
