name: ğŸ“‘ Generate Slides from Google Drive

on:
  workflow_call:
    inputs:
      env:           { required: true,  type: string }
      folder_url:    { required: true,  type: string }
      video_number:  { required: true,  type: string }
  workflow_dispatch:
    inputs:
      env:          { description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)', default: 'ose', type: choice, options: [ose, mep, dde] }
      video_number: { description: 'Video number', default: '0',     required: true }
      folder_url:   { description: 'Google Drive folder URL',        required: true }

jobs:
  make-slides:
    name: "Slides | ${{ inputs.env }} | #${{ inputs.video_number }}"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}

    env:
      FOLDER_URL:         ${{ inputs.folder_url }}
      CHANNEL:            ${{ inputs.env }}
      VIDEO_NUMBER:       ${{ inputs.video_number }}
      CONFIG_JSON:        ${{ vars.CONFIG_JSON }}
      GG_REFRESH_TOKEN:   ${{ secrets.GG_REFRESH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: ğŸ“… Checkout source code
        uses: actions/checkout@v4

      - name: "ğŸ“© Notify: Start slide generation"
        run: |
          export MESSAGE="â–¶ï¸ [$CHANNEL] Video #$VIDEO_NUMBER: Báº¯t Ä‘áº§u táº¡o SLIDE ğŸ“‘"
          node scripts/send_telegram_message.js

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Äá»c & parse CONFIG_JSON (giá»¯ nguyÃªn logic cÅ©)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Validate CONFIG_JSON
        run: |
          echo "$CONFIG_JSON" > config.json
          if ! jq -e '(.dpi and .resolution and .config_key and .maxChar and .minChar and .matchThreshold and .maxOffset)' config.json > /dev/null; then
            echo "âŒ Thiáº¿u trÆ°á»ng báº¯t buá»™c trong CONFIG_JSON" && exit 1
          fi

      - name: ğŸ¤– Parse CONFIG_JSON â‡’ env
        run: |
          echo "$CONFIG_JSON" > config.json
          echo "DPI=$(jq -r '.dpi'           config.json)" >> $GITHUB_ENV
          echo "CONFIG_KEY=$(jq -r '.config_key' config.json)" >> $GITHUB_ENV
          echo "MAX_CHAR=$(jq -r '.maxChar'  config.json)" >> $GITHUB_ENV
          echo "MIN_CHAR=$(jq -r '.minChar'  config.json)" >> $GITHUB_ENV
          echo "MATCH_THRESHOLD=$(jq -r '.matchThreshold' config.json)" >> $GITHUB_ENV
          echo "MAX_OFFSET=$(jq -r '.maxOffset' config.json)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. CÃ i Ä‘áº·tÂ deps & láº¥y file
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: ğŸ“¦ Install Node + Python deps
        run: |
          npm install pptxgenjs fs-extra minimist compromise googleapis
          pip install --upgrade google-api-python-client google-auth google-auth-oauthlib

      - name: ğŸ“‚ Download files tá»« Google Drive
        run: |
          python scripts/download_drive_folder_files.py transcript.srt content.txt background.jpg
          ls -lh input/
          cp input/*.srt . && cp input/*.txt . && cp input/background.jpg . || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Táº¡o timing & SLIDE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§  Generate slidesâ€‘timing.json
        run: |
          node scripts/generate_timing_json_with_parser.js \
            --srt transcript.srt \
            --content content.txt \
            --maxChar "$MAX_CHAR" \
            --minChar "$MIN_CHAR" \
            --matchThreshold "$MATCH_THRESHOLD" \
            --maxOffset "$MAX_OFFSET"
      - name: mv timing
        run: mv slides-timing.json timings.json

      - name: ğŸŒŸ Install font (náº¿u PPTX cáº§n font tuá»³ chá»‰nh)
        run: |
          mkdir -p ~/.fonts && cp assets/fonts/*.ttf ~/.fonts/ && fc-cache -f -v

      - name: ğŸ“œ Generate PPTX from timing
        run: node scripts/gen_slides.js
        env:
          CONFIG_KEY: ${{ env.CONFIG_KEY }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Upload lÃªn Google Drive + thÃ´ng bÃ¡o
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜ï¸ Upload SLIDE to Drive
        run: |
          export UPLOAD_FILES="slides.pptx"
          python scripts/upload_results_to_drive.py

      - name: "ğŸ“© Notify: Slides done"
        run: |
          export MESSAGE="âœ… [$CHANNEL] Video #$VIDEO_NUMBER: ÄÃ£ táº¡o & upload slides.pptx thÃ nh cÃ´ng!"
          node scripts/send_telegram_message.js
