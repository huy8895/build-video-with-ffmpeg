name: ğŸ“… Process from Google Drive and Generate Slides + Video

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)"
        required: true
        default: "ose"
        type: choice
        options:
          - ose
          - mep
          - dde
      video_number:
        description: "Video number"
        required: true
        default: "0"
      folder_url:
        description: "Google Drive folder URL"
        required: true

jobs:
  full-process:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}

    env:
      FOLDER_URL: ${{ inputs.folder_url }}
      VIDEO_NUMBER: ${{ inputs.video_number }}
      CONFIG_JSON: ${{ vars.CONFIG_JSON }}
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: ğŸ“… Checkout source code
        uses: actions/checkout@v4

      - name: âœ… Validate CONFIG_JSON content
        run: |
          echo "$CONFIG_JSON" > config.json
          if ! jq -e '(.dpi and .resolution and .config_key and .upload_to_youtube and .maxChar and .minChar and .matchThreshold and .maxOffset)' config.json > /dev/null; then
            echo "âŒ CONFIG_JSON is missing required fields. Please check JSON structure." && exit 1
          fi

      - name: ğŸ¤– Parse CONFIG_JSON into environment variables
        run: |
          echo "DPI=$(jq -r '.dpi' config.json)" >> $GITHUB_ENV
          echo "RESOLUTION=$(jq -r '.resolution' config.json)" >> $GITHUB_ENV
          echo "CONFIG_KEY=$(jq -r '.config_key' config.json)" >> $GITHUB_ENV
          echo "UPLOAD_TO_YOUTUBE=$(jq -r '.upload_to_youtube' config.json)" >> $GITHUB_ENV
          echo "MAX_CHAR=$(jq -r '.maxChar' config.json)" >> $GITHUB_ENV
          echo "MIN_CHAR=$(jq -r '.minChar' config.json)" >> $GITHUB_ENV
          echo "MATCH_THRESHOLD=$(jq -r '.matchThreshold' config.json)" >> $GITHUB_ENV
          echo "MAX_OFFSET=$(jq -r '.maxOffset' config.json)" >> $GITHUB_ENV

      - name: ğŸª€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install Node + Python dependencies
        run: |
          npm install pptxgenjs fs-extra minimist compromise googleapis
          pip install --upgrade google-api-python-client google-auth google-auth-oauthlib

      - name: ğŸ“‚ âœ Reusable - Download from Google Drive
        uses: ./.github/workflows/steps/download-from-drive.yml

      - name: ğŸ§  âœ Reusable - Generate slide timings
        uses: ./.github/workflows/steps/gen-slide-timings.yml

      - name: ğŸ“œ Generate PPTX from timing
        run: node scripts/gen_slides.js
        env:
          CONFIG_KEY: ${{ env.CONFIG_KEY }}

      - name: ğŸ“„ Convert PPTX to PDF
        run: |
          mkdir -p slides_pdf
          soffice --headless --convert-to pdf --outdir slides_pdf slides.pptx

      - name: ğŸ–¼ Convert PDF to PNG
        run: |
          mkdir -p slides_png
          pdftoppm -png -r "$DPI" slides_pdf/slides.pdf slides_png/slide

      - name: ğŸ“ Generate input.txt
        run: IMAGES_DIR=slides_png node scripts/build_input_list.js

      - name: ğŸ¨ Render video (if enabled)
        run: |
          case "$RESOLUTION" in
            "720p")  SIZE="1280:720" ;;
            "1080p") SIZE="1920:1080" ;;
            *)       SIZE="854:480" ;;
          esac
          ffmpeg -y -f concat -safe 0 -i input.txt -i audio_adjusted.mp3 \
            -vf "scale=$SIZE,format=yuv420p" \
            -c:v libx264 -preset slow -crf 18 \
            -c:a aac -b:a 320k \
            -shortest output.mp4

      - name: "ğŸ“© Notify: Video render complete"
        run: |
          export MESSAGE="ğŸ¬ Video #$VIDEO_NUMBER: Render complete!"
          node scripts/send_telegram_message.js

      - name: â˜ï¸ Upload results to Google Drive
        run: |
          export UPLOAD_FILES="output.mp4"
          python scripts/upload_results_to_drive.py

      - name: "ğŸ“© Notify: Upload done (with Google Drive link)"
        run: |
          export MESSAGE="ğŸ‰ Video #$VIDEO_NUMBER Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ vÃ  upload! ğŸ“‚ Folder: $FOLDER_URL"
          node scripts/send_telegram_message.js

      - name: ğŸš€ Upload to YouTube (if enabled)
        if: ${{ env.UPLOAD_TO_YOUTUBE == 'true' }}
        run: python scripts/upload_youtube.py

      - name: ğŸ“© Send Telegram message with YouTube link (if available)
        if: ${{ env.UPLOAD_TO_YOUTUBE == 'true' }}
        run: |
          YT_LINK=$(cat yt_link.txt)
          export MESSAGE="ğŸ‰ Video #$VIDEO_NUMBER Ä‘Ã£ Ä‘Æ°á»£c upload! ğŸ“º Xem táº¡i: $YT_LINK"
          node scripts/send_telegram_message.js
