name: ğŸŒ Translate SRT from Google Drive

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)'
        required: true
        default: 'ose'
        type: choice
        options:
          - ose
          - mep
          - cdp
      folder_url:
        description: "Google Drive folder URL chá»©a file SRT gá»‘c"
        required: true
      source_srt_filename:
        description: "TÃªn file SRT gá»‘c trong folder (vÃ­ dá»¥: raw_cn.srt)"
        required: true
        default: "raw_cn.srt"
      languages:
        description: "Danh sÃ¡ch ngÃ´n ngá»¯ Ä‘Ã­ch, cÃ¡ch nhau báº±ng dáº¥u pháº©y (vÃ­ dá»¥: English, Vietnamese)"
        required: true
        default: "English, Vietnamese"
      model:
        description: 'Gemini model (vÃ­ dá»¥ gemini-2.5-pro)'
        required: false
        default: 'gemini-2.5-pro'
      thinking_budget:
        description: 'Thinking budget (-1 dynamic, 0 off, or positive int)'
        required: false
        default: '-1'

jobs:
  translate-and-upload:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    env:
      # Secrets Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i Google Drive API
      FOLDER_URL:       ${{ inputs.folder_url }}
      GG_REFRESH_TOKEN: ${{ secrets.GG_REFRESH_TOKEN }}
      YT_CLIENT_ID:     ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      # Secret cho Gemini API
      GEMINI_API_KEY:   ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai google-auth google-api-python-client

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Táº£i file SRT gá»‘c tá»« Google Drive
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‚ Download source SRT from Drive
        id: download_srt
        run: |
          set -euo pipefail
          SOURCE_FILE="${{ inputs.source_srt_filename }}"
          python scripts/download_drive_folder_files.py "$SOURCE_FILE"
          
          # Kiá»ƒm tra file Ä‘Ã£ táº£i vá» thÃ nh cÃ´ng chÆ°a
          if [ ! -f "input/$SOURCE_FILE" ]; then
            echo "::error::Failed to download $SOURCE_FILE from Google Drive."
            exit 1
          fi
          
          echo "SRT_PATH=input/$SOURCE_FILE" >> $GITHUB_ENV
          echo "SRT_BASE_NAME=$(basename "$SOURCE_FILE" .srt)" >> $GITHUB_ENV
          echo "Downloaded file:"
          ls -lh "input/$SOURCE_FILE"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Láº·p qua cÃ¡c ngÃ´n ngá»¯ vÃ  dá»‹ch
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”„ Translate for each language
        id: run_translations
        run: |
          set -euo pipefail
          ALL_OUTPUT_FILES="" # Chuá»—i Ä‘á»ƒ lÆ°u tÃªn táº¥t cáº£ cÃ¡c file output

          # Chuyá»ƒn Ä‘á»•i chuá»—i "lang1, lang2" thÃ nh má»™t máº£ng Ä‘á»ƒ láº·p
          IFS=',' read -r -a LANG_ARRAY <<< "${{ inputs.languages }}"

          for lang_raw in "${LANG_ARRAY[@]}"; do
            # Trim whitespace
            lang=$(echo "$lang_raw" | xargs)
            echo "---"
            echo "ğŸš€ Starting translation to: $lang"
            
            # Táº¡o tÃªn file output an toÃ n (vÃ­ dá»¥: raw_cn.English.srt)
            SAFE_LANG=$(echo "$lang" | tr ' ' '_')
            OUT_PATH="output/${{ env.SRT_BASE_NAME }}.${SAFE_LANG}.srt"
            
            # Táº¡o thÆ° má»¥c output náº¿u chÆ°a cÃ³
            mkdir -p output

            python scripts/translate_srt.py \
              --input "${{ env.SRT_PATH }}" \
              --language "$lang" \
              --output "$OUT_PATH" \
              --model "${{ inputs.model }}" \
              --thinking-budget "${{ inputs.thinking_budget }}"
            
            # ThÃªm file output vÃ o danh sÃ¡ch Ä‘á»ƒ upload
            ALL_OUTPUT_FILES="$ALL_OUTPUT_FILES $OUT_PATH"
          done
          
          # LÆ°u danh sÃ¡ch file output vÃ o biáº¿n mÃ´i trÆ°á»ng cho bÆ°á»›c sau
          echo "ALL_TRANSLATED_FILES=${ALL_OUTPUT_FILES# }" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Upload táº¥t cáº£ káº¿t quáº£ lÃªn Google Drive
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜ï¸ Upload all results to Drive
        run: |
          if [ -z "${{ env.ALL_TRANSLATED_FILES }}" ]; then
            echo "No files were translated. Skipping upload."
          else
            echo "Uploading files: ${{ env.ALL_TRANSLATED_FILES }}"
            # Script upload_results_to_drive.py cáº§n Ä‘á»c biáº¿n mÃ´i trÆ°á»ng UPLOAD_FILES
            export UPLOAD_FILES="${{ env.ALL_TRANSLATED_FILES }}"
            python scripts/upload_results_to_drive.py
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Hiá»ƒn thá»‹ káº¿t quáº£
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“œ Show a preview of generated files
        run: |
          echo "âœ… Translation process completed."
          echo "Generated files:"
          ls -lhR output/