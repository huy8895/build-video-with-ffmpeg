name: ğŸ§­ 5.3 Process Audio And SRT wavs

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string
      folder_url:
        required: true
        type: string
      video_number:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      env:
        description: 'Chá»n mÃ´i trÆ°á»ng (ose, mep, dde)'
        required: true
        default: 'ose'
        type: string
      folder_url:
        description: 'Link folder Google Drive chá»©a audio.zip hoáº·c cÃ¡c file .wav'
        required: true
      video_number:
        description: 'Sá»‘ Thá»© tá»± video (1, 2, 3, ...)'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    name: "Audio Channel: ${{ inputs.env }} | Video: #${{ inputs.video_number }}"

    env:
      CHANNEL: ${{ inputs.env }}
      FOLDER_URL: ${{ inputs.folder_url }}
      VIDEO_NUMBER: ${{ inputs.video_number }}
      CONFIG_JSON: ${{ vars.CONFIG_JSON }}
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      GG_REFRESH_TOKEN: ${{ secrets.GG_REFRESH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      - name: Install dependencies send mail
        run: npm install nodemailer

      - name: ğŸ§ª Parse CONFIG_JSON into environment variables
        id: parse
        run: |
          echo "$CONFIG_JSON" > config.json
          echo "WHISPER_MODEL=$(jq -r '.whisper_model' config.json)" >> $GITHUB_ENV
          echo "SPEED=$(jq -r '.speed' config.json)" >> $GITHUB_ENV
          echo "MAX_WORDS_PER_LINE=$(jq -r '.max_words_per_line' config.json)" >> $GITHUB_ENV
          echo "LANGUAGE=$(jq -r '.language' config.json)" >> $GITHUB_ENV
          echo "VOLUME=$(jq -r '.volume' config.json)" >> $GITHUB_ENV
          echo "EMAIL=$(jq -r '.email' config.json)" >> $GITHUB_ENV

      - name: ğŸ Táº¡o link Ä‘áº¿n workflow run
        run: |
          echo "RUN_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

      - name: "ğŸ“© Notify: Start processing AUDIO"
        run: |
          export MESSAGE="ğŸ Start Process Audio ğŸ§| ğŸ“º Channel: [$CHANNEL] | Video: #$VIDEO_NUMBER ğŸ§  WhisperModel: $WHISPER_MODEL | ğŸšï¸ Speed: $SPEED | ğŸ—£ï¸ Lang: $LANGUAGE ğŸ“ Folder: $FOLDER_URL ğŸ”— View run: $RUN_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}

      - name: ğŸ Install Python & Google API packages
        run: pip install google-auth google-api-python-client

      # --- START: Thay Ä‘á»•i ---
      - name: â¬‡ï¸ Download all files from Drive folder
        run: python scripts/download_drive_folder_files_all.py
      # --- END: Thay Ä‘á»•i ---

      # --- START: Thay Ä‘á»•i (Logic kiá»ƒm tra file linh hoáº¡t hÆ¡n) ---
      - name: ğŸ§ª XÃ¡c Ä‘á»‹nh nguá»“n audio (zip, mp3 hay wav)
        id: check_source
        run: |
          if [ -f input/audio.zip ]; then
            echo "âœ… TÃ¬m tháº¥y audio.zip. Sáº½ xá»­ lÃ½ theo luá»“ng MP3 (ná»‘i file)."
            echo "AUDIO_SOURCE=mp3_zip" >> $GITHUB_ENV
          elif ls input/*.mp3 1> /dev/null 2>&1; then
            echo "âœ… TÃ¬m tháº¥y file .mp3 Ä‘á»™c láº­p. Sáº½ xá»­ lÃ½ theo luá»“ng MP3 hÃ ng loáº¡t."
            echo "AUDIO_SOURCE=mp3_batch" >> $GITHUB_ENV
          elif ls input/*.wav 1> /dev/null 2>&1; then
            echo "âœ… TÃ¬m tháº¥y file .wav. Sáº½ xá»­ lÃ½ theo luá»“ng WAV."
            echo "AUDIO_SOURCE=wav" >> $GITHUB_ENV
          else
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y file 'audio.zip', '.mp3' hoáº·c '.wav' nÃ o trong thÆ° má»¥c 'input/'."
            exit 1
          fi
      # --- END: Thay Ä‘á»•i ---

      - name: ğŸ› ï¸ CÃ i Ä‘áº·t FFMPEG & Whisper
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install --upgrade pip setuptools-rust openai-whisper

      # =================================================================
      # == LUá»’NG Xá»¬ LÃ MP3 (Tá»ª FILE ZIP)
      # =================================================================
      - name: ğŸ“‚ Giáº£i nÃ©n file audio.zip
        if: env.AUDIO_SOURCE == 'mp3_zip'
        run: |
          rm -rf audio merged
          mkdir -p audio merged
          unzip -o input/audio.zip -d audio
          find audio -maxdepth 1 -type f -name "*.mp3" | sort -V > merged/sorted.txt
          cat merged/sorted.txt

      - name: ğŸ”— Ná»‘i táº¥t cáº£ file .mp3
        if: env.AUDIO_SOURCE == 'mp3_zip'
        run: |
          mkdir -p merged
          while read f; do
            echo "file '$PWD/$f'" >> merged/list.txt
          done < merged/sorted.txt
          ffmpeg -f concat -safe 0 -i merged/list.txt -c copy merged/merged.mp3

      - name: ğŸ¢ Äiá»u chá»‰nh tá»‘c Ä‘á»™ & Ã¢m lÆ°á»£ng audio
        if: env.AUDIO_SOURCE == 'mp3_zip'
        run: |
          mkdir -p adjusted
          BITRATE=$(ffprobe -v error -select_streams a:0 -show_entries stream=bit_rate -of csv=p=0 merged/merged.mp3)
          if [ -z "$BITRATE" ] || [ "$BITRATE" = "N/A" ]; then
            echo "âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c bitrate â€“ dÃ¹ng VBR cháº¥t lÆ°á»£ng cao (q=0)."
            ffmpeg -i merged/merged.mp3 -filter:a "atempo=$SPEED,volume=$VOLUME" -c:a libmp3lame -q:a 0 adjusted/audio_adjusted.mp3
          else
            echo "â¡ï¸ MÃ£ hoÃ¡ láº¡i á»Ÿ $BITRATE bps (giá»¯ nguyÃªn nhÆ° gá»‘c)."
            ffmpeg -i merged/merged.mp3 -filter:a "atempo=$SPEED,volume=$VOLUME" -c:a libmp3lame -b:a ${BITRATE} adjusted/audio_adjusted.mp3
          fi

      - name: âœï¸ Táº¡o phá»¥ Ä‘á» SRT (tá»« file MP3 Ä‘Ã£ xá»­ lÃ½)
        if: env.AUDIO_SOURCE == 'mp3_zip'
        run: |
          whisper adjusted/audio_adjusted.mp3 \
            --model "$WHISPER_MODEL" \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line "$MAX_WORDS_PER_LINE" \
            --output_dir output --task transcribe        
          mv output/audio_adjusted.srt transcript.srt
          cp adjusted/audio_adjusted.mp3 audio_adjusted.mp3
      # =================================================================
      # == Káº¾T THÃšC LUá»’NG Xá»¬ LÃ MP3
      # =================================================================


      # --- START: Cáº¬P NHáº¬T (Xá»­ lÃ½ hiá»‡u quáº£ nhiá»u file WAV) ---
      # =================================================================
      # == LUá»’NG Xá»¬ LÃ WAV (Xá»¬ LÃ HÃ€NG LOáº T)
      # =================================================================
      - name: âœï¸ Táº¡o phá»¥ Ä‘á» SRT (tá»« cÃ¡c file WAV, xá»­ lÃ½ hÃ ng loáº¡t)
        if: env.AUDIO_SOURCE == 'wav'
        run: |
          set -e
          mkdir -p output
          NUM_FILES=$(ls -1 input/*.wav 2>/dev/null | wc -l)
          if [ "$NUM_FILES" -eq 0 ]; then
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y file .wav nÃ o Ä‘á»ƒ xá»­ lÃ½."
            exit 0
          fi

          echo "ğŸš€ Báº¯t Ä‘áº§u phiÃªn dá»‹ch hÃ ng loáº¡t cho $NUM_FILES file .wav..."
          echo "Model [$WHISPER_MODEL] sáº½ chá»‰ Ä‘Æ°á»£c táº£i Má»˜T Láº¦N."

          # BÆ°á»›c 1: Cháº¡y whisper cho táº¥t cáº£ cÃ¡c file .wav cÃ¹ng lÃºc.
          # Tool sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ tuáº§n tá»±, nhÆ°ng chá»‰ load model má»™t láº§n.
          # `input/*.wav` sáº½ Ä‘Æ°á»£c shell expand thÃ nh danh sÃ¡ch cÃ¡c file.
          whisper input/*.wav \
            --model "$WHISPER_MODEL" \
            --language "$LANGUAGE" \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line "$MAX_WORDS_PER_LINE" \
            --output_dir "output" \
            --task transcribe

          echo "âœ… PhiÃªn dá»‹ch hoÃ n táº¥t. Báº¯t Ä‘áº§u Ä‘á»•i tÃªn file output..."

          # BÆ°á»›c 2: Äá»•i tÃªn cÃ¡c file .srt Ä‘Ã£ táº¡o Ä‘á»ƒ cÃ³ tiá»n tá»‘ "transcript-"
          # Whisper sáº½ táº¡o ra file output cÃ³ cÃ¹ng tÃªn vá»›i file input (vÃ­ dá»¥: audio1.srt)
          for srt_file in output/*.srt; do
            BASENAME=$(basename "$srt_file") # Láº¥y ra "audio1.srt"
            mv "$srt_file" "transcript-$BASENAME"
            echo "   - ÄÃ£ Ä‘á»•i tÃªn thÃ nh: transcript-$BASENAME"
          done

          echo "âœ… Táº¥t cáº£ cÃ¡c file Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»•i tÃªn."
      # =================================================================
      # == Káº¾T THÃšC LUá»’NG Xá»¬ LÃ WAV
      # =================================================================
      - name: âœï¸ Táº¡o phá»¥ Ä‘á» SRT (tá»« cÃ¡c file MP3, xá»­ lÃ½ hÃ ng loáº¡t)
        if: env.AUDIO_SOURCE == 'mp3_batch'
        run: |
          set -e
          mkdir -p output
          NUM_FILES=$(ls -1 input/*.mp3 2>/dev/null | wc -l)
          if [ "$NUM_FILES" -eq 0 ]; then
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y file .mp3 nÃ o Ä‘á»ƒ xá»­ lÃ½."
            exit 0
          fi

          echo "ğŸš€ Báº¯t Ä‘áº§u phiÃªn dá»‹ch hÃ ng loáº¡t cho $NUM_FILES file .mp3..."
          echo "Model [$WHISPER_MODEL] sáº½ chá»‰ Ä‘Æ°á»£c táº£i Má»˜T Láº¦N."

          whisper input/*.mp3 \
            --model "$WHISPER_MODEL" \
            --language "$LANGUAGE" \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line "$MAX_WORDS_PER_LINE" \
            --output_dir "output" \
            --task transcribe

          echo "âœ… PhiÃªn dá»‹ch hoÃ n táº¥t. Báº¯t Ä‘áº§u Ä‘á»•i tÃªn file output..."

          for srt_file in output/*.srt; do
            BASENAME=$(basename "$srt_file" .srt)
            mv "output/$BASENAME.srt" "transcript-$BASENAME.srt"
            echo "   - ÄÃ£ Ä‘á»•i tÃªn thÃ nh: transcript-$BASENAME.srt"
          done

          echo "âœ… Táº¥t cáº£ cÃ¡c file Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»•i tÃªn."
      # --- START: Thay Ä‘á»•i (Chuáº©n bá»‹ file upload linh hoáº¡t) ---
      - name: â˜ï¸ Chuáº©n bá»‹ danh sÃ¡ch file Ä‘á»ƒ upload
        id: prepare_upload
        run: |
          if [ "${{ env.AUDIO_SOURCE }}" == "mp3_zip" ]; then
            echo "UPLOAD_FILES=audio_adjusted.mp3 transcript.srt" >> $GITHUB_ENV
          elif [ "${{ env.AUDIO_SOURCE }}" == "mp3_batch" ] || [ "${{ env.AUDIO_SOURCE }}" == "wav" ]; then
            # Chá»‰ láº¥y cÃ¡c file transcript-*.srt
            FILE_LIST=$(ls transcript-*.srt 2>/dev/null | tr '\n' ' ')
            if [ -z "$FILE_LIST" ]; then
              echo "âŒ KhÃ´ng tÃ¬m tháº¥y file .srt nÃ o Ä‘á»ƒ upload."
              exit 1
            fi
            echo "File sáº½ Ä‘Æ°á»£c upload: $FILE_LIST"
            echo "UPLOAD_FILES=$FILE_LIST" >> $GITHUB_ENV
          else
            echo "âŒ KhÃ´ng nháº­n dáº¡ng Ä‘Æ°á»£c loáº¡i file audio."
            exit 1
          fi

      - name: â˜ï¸ Upload káº¿t quáº£ lÃªn Google Drive
        run: |
          export UPLOAD_FILES="${{ env.UPLOAD_FILES }}"
          python scripts/upload_results_to_drive.py
      # --- END: Thay Ä‘á»•i ---

      - name: ğŸš€ Gá»­i tin nháº¯n Telegram
        run: |
          export MESSAGE="ğŸŒ˜ Done Process Audio! Channel [$CHANNEL] Video: #$VIDEO_NUMBER | WhisperModel: $WHISPER_MODEL | Speed: $SPEED | Lang: $LANGUAGE | âœ… Done! ğŸ“ $FOLDER_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}

      - name: ğŸ“› Notify Telegram if job failed
        if: failure()
        run: |
          export MESSAGE="âŒ ${{ github.workflow }} tháº¥t báº¡i! Channel [$CHANNEL] Video: #$VIDEO_NUMBER | ğŸ“ $FOLDER_URL"
          node scripts/send_telegram_message.js
          node scripts/sendMail.js
        env:
          CONFIG_EMAIL: ${{ vars.CONFIG_EMAIL }}